# 5강: Docker Compose 설정
# 로컬 개발 및 Production 배포용 컨테이너 설정
#
# 사용법:
#   # 로컬 개발 (빌드 + 실행)
#   docker-compose up --build
#
#   # Production (GHCR 이미지 사용)
#   LUMI_IMAGE=ghcr.io/owner/repo:tag docker-compose up -d
#
#   # 백그라운드 실행
#   docker-compose up -d
#
#   # 로그 확인
#   docker-compose logs -f
#
#   # 종료
#   docker-compose down
#
# 서비스 구성:
#   - lumi-agent: FastAPI 에이전트 서버 (메인)
#   - (Supabase는 클라우드 서비스 사용)
#   - (Redis는 6강에서 추가 예정)

services:
  # =============================================================
  # 메인 에이전트 서비스
  # =============================================================
  lumi-agent:
    # TODO 1: 이미지 및 빌드 설정
    image: ${LUMI_IMAGE:-lumi-agent:latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: lumi-agent

    # TODO 2: 포트 매핑 (호스트:컨테이너)
    ports:
      - "8000:8000"

    # TODO 3: 환경변수 설정
    environment:
      - UPSTAGE_API_KEY=${UPSTAGE_API_KEY}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - DEBUG=false

    # TODO 4: 헬스체크 및 재시작 정책 설정
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    restart: unless-stopped
